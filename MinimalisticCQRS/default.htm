<html>
<head>
    <title>Minimalistic CQRS POC</title>
    <script src="Scripts/jquery-1.6.4.min.js" type="text/javascript"></script>
    <script src="Scripts/jquery.signalR.min.js" type="text/javascript"></script>
    <script src="Scripts/jQuery.tmpl.min.js" type="text/javascript"></script>
    <script src="signalr/hubs" type="text/javascript"></script>
    <script type="text/javascript">
        $(function () {
            $.fn.serializeObject = function () {
                var o = {};
                var a = this.serializeArray();
                $.each(a, function () {
                    if (o[this.name] !== undefined) {
                        if (!o[this.name].push) {
                            o[this.name] = [o[this.name]];
                        }
                        o[this.name].push(this.value || '');
                    } else {
                        o[this.name] = this.value || '';
                    }
                });
                return o;
            };

            var qryHub = $.connection.queryHub;
            var cmdHub = $.connection.commandHub;
            qryHub.UpdateBalance = function (id, balance) {
                $("#details tr[data-id='" + id + "'] td[name='balance']").text(balance);
            };
            qryHub.AddAccountDetails = function (details) {
                $("#accountTemplate").tmpl(details).appendTo("#details");
            };

            qryHub.AddChatMessage = function (username, message) {
                var res = $("#chatTemplate").tmpl({ username: username, message: message, time: new Date() });
                $("#msgbox").append(res);
            }
            $.connection.hub.start(function () {
                qryHub.getDetails().done(function (res) {
                    var $details = $("#details");
                    $details.empty();
                    for (var key in res) {
                        var v = res[key];
                        $("#accountTemplate").tmpl(v).appendTo($details);
                    };
                });
            });

            $("#registerAccount").submit(function () {
                var res = $(this).serializeObject();
                cmdHub
                    .registerAccount(res.AccountId, res.OwnerName, res.AccountNumber)
                    .fail(function (msg) {
                        alert(msg);
                    });
                return false;
            });
            $("#depositAmount").submit(function (frm) {
                var res = $(this).serializeObject();
                cmdHub.depositAmount(res.AccountId, res.Amount).fail(function (msg) { alert(msg); });
                return false;
            });
            $("#withdrawAmount").submit(function (frm) {
                var res = $(this).serializeObject();
                cmdHub.withdrawAmount(res.AccountId, res.Amount).fail(function (msg) { alert(msg); });
                return false;
            });

            $("#saySomething").submit(function (frm) {
                var res = $(this).serializeObject();
                cmdHub
                    .saySomething(res.username, res.message)
                    .done(function () { $("#saySomething textarea").empty(); })
                    .fail(function (msg) { alert(msg); });
                return false;
            });

        });
    </script>
    <script id="accountTemplate" type="text/x-jquery-tmpl">
            <tr data-id="${Id}">
                <td>${Id}</td>
                <td>${OwnerName}</td>
                <td>${AccountNumber}</td>
                <td name="balance">${Balance}</td>
            </tr>
    </script>
    <script id="chatTemplate" type="text/x-jquery-tmpl">
        <b>${username}</b>:<small>${time}</small><br/>${message}<br/>
    </script>
</head>
<body>
    <header>
        <h1>Minimalistic CQRS POC</h1>
        <p>This uses realtime collaboration between all connected users, So if another user adds an account, deposits or withdraws, you'll notice !!</p>
        <p>Feel free to enter a chat message...
        </p>
        <p>Source: <a href="https://github.com/ToJans/MinimalisticCQRS">github</a></p>
        <p>Contact: <a href="https://twitter.com/#!/ToJans">Tojans@Twitter</a></p>
        <table>
            <thead>
                <tr>
                    <th>Id</th>
                    <th>OwnerName</th>
                    <th>AccountNumber</th>
                    <th>Balance</th>
                </tr>
            </thead>
            <tbody id="details"></tbody>
        </table>
    </header>
    <sidebar style="float: right; width: 40%">
            <h4>Chat is also realtime</h4>
            <form id="saySomething" action="#">  
                <fieldset>
                    <label>Username</label><input type="text" name="username" value="[AnonymousCoward]"  /><br />
                    <label>Message</label><textarea name="message" style="width:100%"></textarea><br />
                    <input type="submit" />
                </fieldset>
            </form>
            <div id="msgbox">
            </div>
        </sidebar>
    <section id="commands">
        <form id="registerAccount" action="#">   
            <fieldset>
                <label>AccountId</label><input type="text" name="AccountId" value="account/1"/><br />
                <label>Ownername</label><input type="text" name="OwnerName" value="Tom Janssens"/><br />
                <label>Account number</label><input type="text" name="AccountNumber" value="123-4567890-123" /><br />
                <input type="submit" />
            </fieldset>
        </form>
        <form id="depositAmount" action="#">  
            <fieldset>
                <label>AccountId</label><input type="text" name="AccountId" value="account/1" /><br />
                <label>Amount</label><input type="text" name="Amount" value="3" /><br />
                <input type="submit" />
            </fieldset>
        </form>
        <form id="withdrawAmount" action="#">  
            <fieldset>
                <label>AccountId</label><input type="text" name="AccountId" value="account/1"  /><br />
                <label>Amount</label><input type="text" name="Amount" value="3" /><br />
                <input type="submit" />
            </fieldset>
        </form>
    </section>
    <footer>
    <p>
        &copy; Core BVBA 2011
    </p>
    </footer>
</body>
</html>
